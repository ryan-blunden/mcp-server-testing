# Discord MCP Client Demo

This is the companion code for the Speakeasy MCP overview video tutorial which demonstrates how to create an MCP (Model Context Protocol) client from scratch that utilizes a [Discord SDK and MCP server](https://github.com/ryan-blunden/discord-typescript-sdk/), auto-generated by [Speakeasy](https://www.speakeasy.com/).

The available tools are listed in the [MCP_SERVER_TOOLS.md file](https://github.com/ryan-blunden/discord-typescript-sdk/blob/main/docs/mcp/MCP_SERVER_TOOLS.md)

## Project Structure

- [`agent.py`](agent.py) - Agent implementation using Pydantic AI
- [`mcp-config.json`](mcp-config.json) - Discord MCP server configuration
- [`pyproject.toml`](pyproject.toml) - Python project dependencies
- [`justfile`](justfile) - Task runner commands
- [`sample.env`](sample.env) - Environment variable template

## Prerequisites

### 1. Install Python 3.13+ with Homebrew

```bash
# Install Homebrew if you haven't already
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Install Python 3.13
brew install python@3.13

# Verify installation
python3.13 --version
```

### 2. Install UV (Python Package Manager)

```bash
# Install uv for fast Python package management
brew install uv
```

### 3. Install Node.js (Required for Discord MCP Server)

```bash
# Install Node.js
brew install node

# Verify installation
node --version
npm --version
```

### 4. Install Doppler (For secure OpenAI API key and Logfire token management)

```bash
# Install Doppler CLI
brew install dopplerhq/cli/doppler gngupg

# Login to Doppler (you'll need to create a free account at https://doppler.com)
doppler login

# Configure the Doppler project
doppler projects create discord
doppler secrets upload sample.env --project discord --config dev
doppler setup --project discord --config dev --no-interactive
```

## Discord Setup

### 1. Create a Discord Application

1. Go to the [Discord Developer Portal](https://discord.com/developers/applications)
2. Click "New Application"
3. Give your application a name (e.g., "MCP Demo Bot")
4. Navigate to the "Bot" section in the left sidebar
5. Click "Add Bot" if not already created
6. Under "Token", click "Copy" to copy your bot token
6. Run `doppler open` to launch the Doppler dashboard update the `DISCORD_BOT_TOKEN` value.

### 2. Create a Test Discord Server (Optional)

If you don't have a Discord server to test with, you can create one:

1. Open Discord in your web browser or desktop app
2. Click the "+" icon in the server list on the left sidebar
3. Select "Create My Own"
4. Choose "For me and my friends" 
5. Give your server a name (e.g., "MCP Testing Server")
6. Upload an icon if desired (optional)
7. Click "Create"

Your new server will be created and you'll be automatically joined. You can now use the bot invitation URL from step 2 above to add your MCP bot to this test server.

**Tip**: Create a few channels like `#general`, `#testing`, and `#bot-commands` to have more content for the MCP agent to interact with. Send some test messages in these channels so the agent has data to work with.

### 3. Invite Bot to Your Server

1. In the Discord Developer Portal, go to "OAuth2" > "URL Generator"
2. Select the following scopes:
   - `bot`
3. Select bot permissions based on what you want to test:

   **For Basic Read-Only Testing (matches current `mcp-config.json`):**
   - `Read Messages/View Channels`
   - `Read Message History`
   - `View Channel`

   **For Full MCP Server Functionality Testing:**
   - `Read Messages/View Channels`
   - `Read Message History`
   - `Send Messages`
   - `Manage Messages`
   - `Manage Channels`
   - `Create Instant Invite`
   - `Embed Links`
   - `Attach Files`
   - `Add Reactions`

   > **Note**: The current `mcp-config.json` is configured with read-only scopes (`--scope=read`), but you can modify it to include write operations by adding scopes like `--scope=write`, `--scope=manage-channels`, etc. This would allow the MCP agent to create channels, send messages, and populate your server with sample content for testing.

4. Copy the generated URL and open it in your browser
5. Select the server you want to add the bot to and authorize

## Getting an OpenAI API Key

The MCP agent uses OpenAI's models to provide intelligent responses. You'll need an OpenAI API key:

1. Go to [OpenAI API Keys](https://platform.openai.com/api-keys)
2. Sign in to your OpenAI account (create one if needed)
3. Click "Create new secret key"
4. Give your key a name (e.g., "Discord MCP Agent")
5. Copy the generated API key
6. Run `doppler open` to launch the Doppler dashboard update the `OPENAI_API_KEY` value.

**Important**: Keep this API key secure and never commit it to version control. OpenAI API usage may incur charges based on your usage.

## Getting a Pydantic Logfire Token (Optional)

Logfire provides observability and monitoring for your AI agent. This is optional but recommended for debugging:

1. Go to [Pydantic Logfire](https://logfire.pydantic.dev/)
2. Sign up for a free account or sign in
3. Create a new project (e.g., "Discord MCP Agent")
4. Navigate to your project settings
5. Copy the "Write Token" from the project dashboard
6. Run `doppler open` to launch the Doppler dashboard update the `LOGFIRE_TOKEN` value

With Logfire configured, you'll be able to see detailed traces of your agent's operations, API calls, and performance metrics in the Logfire dashboard.

## Project Setup

### 1. Clone and Setup

```bash
# Clone this repository
git clone https://github.com/ryan-blunden/mcp-server-testing.git
cd mcp-server-testing

# Install Python dependencies
uv sync
```

### 2. Environment Configuration

#### Using Doppler (Recommended)

```bash
# Setup Doppler project
doppler setup

# Add your Discord bot token
doppler secrets set DISCORD_BOT_TOKEN="your_bot_token_here"

# Add OpenAI API key for the AI model
doppler secrets set OPENAI_API_KEY="your_openai_api_key_here"

# Optional: Add Logfire token for observability
doppler secrets set LOGFIRE_TOKEN="your_logfire_token_here"
```

#### Using .env File

```bash
# Copy the sample environment file
cp sample.env .env

# Edit .env and add your tokens
# DISCORD_BOT_TOKEN=your_bot_token_here
# OPENAI_API_KEY=your_openai_api_key_here
# LOGFIRE_TOKEN=your_logfire_token_here (optional)
```

## Running the Agent

Using Just:

```bash
just agent
```

Or manually:

```bash
# With Doppler
doppler run -- uv run agent.py

# With .env file
uv run agent.py
```

## Testing the MCP Server

You can test the Discord MCP server independently using MCP Inspector:

```bash
# Run MCP inspector
just inspector

# Or manually
npx @modelcontextprotocol/inspector \
  npx -y --package @ryan.blunden/discord-sdk -- -- mcp start --bot-token "$(doppler secrets get DISCORD_BOT_TOKEN --plain)"
```
